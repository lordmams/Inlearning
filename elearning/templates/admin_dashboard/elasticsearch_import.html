{% extends 'admin_dashboard/base_admin.html' %}

{% block title %}Import via Consumer{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- En-tête -->
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Import via Consumer</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <a href="{% url 'admin_dashboard:download_course_template' %}?format=json" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> Template JSON
                        </a>
                        <a href="{% url 'admin_dashboard:download_course_template' %}?format=csv" class="btn btn-outline-primary">
                            <i class="fas fa-download"></i> Template CSV
                        </a>
                    </div>
                </div>
            </div>

            <!-- Informations importantes -->
            <div class="alert alert-info" role="alert">
                <h4 class="alert-heading"><i class="fas fa-info-circle"></i> Information importante</h4>
                <p>Cette interface dépose les cours dans le <strong>système de fichiers surveillé</strong> où le consumer les traite automatiquement via le pipeline de données.</p>
                <ul class="mb-0">
                    <li>Formats supportés : JSON et CSV</li>
                    <li>Taille maximale : 10MB par fichier</li>
                    <li>Le consumer traite automatiquement les fichiers déposés</li>
                    <li>Le pipeline enrichit les données (catégories, niveaux, embeddings) avant indexation</li>
                    <li>Utilisez "Validation uniquement" pour tester votre fichier avant dépôt</li>
                </ul>
            </div>

            <!-- Formulaire d'import -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-upload"></i> Importer des cours
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.file.id_for_label }}" class="form-label">
                                        {{ form.file.label }}
                                    </label>
                                    {{ form.file }}
                                    {% if form.file.help_text %}
                                        <div class="form-text">{{ form.file.help_text }}</div>
                                    {% endif %}
                                    {% if form.file.errors %}
                                        {% for error in form.file.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.format_type.id_for_label }}" class="form-label">
                                        {{ form.format_type.label }}
                                    </label>
                                    {{ form.format_type }}
                                    {% if form.format_type.errors %}
                                        {% for error in form.format_type.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-check">
                                    {{ form.validate_only }}
                                    <label class="form-check-label" for="{{ form.validate_only.id_for_label }}">
                                        Validation uniquement (ne pas envoyer au pipeline)
                                    </label>
                                    <div class="form-text">Cochez pour valider le format sans envoyer au pipeline Spark</div>
                                </div>
                            </div>
                        </div>

                        <!-- Erreurs générales du formulaire -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger mt-3">
                                {% for error in form.non_field_errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-upload"></i> 
                                <span id="submit-text">Déposer pour le Consumer</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Résultats de l'import -->
            {% if show_results and results %}
            <div class="card mt-4">
                {% if results.file_saved %}
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-check-circle"></i> Fichier déposé avec succès
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-file-check"></i> Fichier prêt pour traitement
                        </h6>
                        <p><strong>Fichier original :</strong> {{ results.original_filename }}</p>
                        <p><strong>Fichier sauvegardé :</strong> {{ results.filename }}</p>
                        <p><strong>Message :</strong> {{ results.consumer_message }}</p>
                        <hr>
                        <p class="mb-0">
                            <i class="fas fa-info-circle"></i> 
                            Le consumer va automatiquement traiter ce fichier et l'envoyer au pipeline de données.
                            Consultez les logs du consumer pour suivre le traitement.
                        </p>
                    </div>
                </div>
                {% else %}
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> Résultats de la validation
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Statistiques -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">{{ results.total_courses }}</h5>
                                    <p class="card-text">Cours traités</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success">{{ results.successful_imports }}</h5>
                                    <p class="card-text">Succès</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-danger">{{ results.failed_imports }}</h5>
                                    <p class="card-text">Échecs</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-info">
                                        {% if results.total_courses > 0 %}
                                            {% widthratio results.successful_imports results.total_courses 100 %}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </h5>
                                    <p class="card-text">Taux de succès</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                    <!-- Liste des cours traités (uniquement pour la validation) -->
                    {% if results.imported_courses and not results.file_saved %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Titre du cours</th>
                                    <th>ID Elasticsearch</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for course in results.imported_courses %}
                                <tr>
                                    <td>{{ course.index }}</td>
                                    <td>{{ course.title }}</td>
                                    <td>
                                        {% if course.id %}
                                            <code>{{ course.id }}</code>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if course.status == "Importé" %}
                                            <span class="badge bg-success">{{ course.status }}</span>
                                        {% elif course.status == "Validé" %}
                                            <span class="badge bg-info">{{ course.status }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ course.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    <!-- Erreurs (uniquement pour la validation) -->
                    {% if results.errors and not results.file_saved %}
                    <div class="mt-4">
                        <h6 class="text-danger">
                            <i class="fas fa-exclamation-triangle"></i> Erreurs rencontrées
                        </h6>
                        <div class="alert alert-danger">
                            <ul class="mb-0">
                                {% for error in results.errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </div>  <!-- End validation body -->
                {% endif %}  <!-- End validation/file_saved condition -->
            </div>

            <!-- Guide d'utilisation -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-question-circle"></i> Guide d'utilisation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Format JSON</h6>
                            <p>Structure attendue :</p>
                            <pre class="bg-light p-3 small"><code>{
  "url": "https://exemple.com/cours",
  "cours": {
    "id": "cours_001",
    "titre": "Titre du cours",
    "description": "Description",
    "contenus": {
      "paragraphs": ["paragraphe 1"],
      "lists": [["item1", "item2"]],
      "examples": ["code exemple"]
    },
    "categories": ["cat1", "cat2"],
    "niveau": "Débutant"
  }
}</code></pre>
                        </div>
                        <div class="col-md-6">
                            <h6>Format CSV</h6>
                            <p>Colonnes requises :</p>
                            <ul>
                                <li><code>titre</code> - Titre du cours (requis)</li>
                                <li><code>description</code> - Description (requis)</li>
                                <li><code>niveau</code> - Niveau de difficulté (requis)</li>
                                <li><code>categories</code> - Catégories (séparées par virgules)</li>
                                <li><code>paragraphs</code> - Paragraphes (séparés par virgules)</li>
                                <li><code>examples</code> - Exemples (séparés par virgules)</li>
                            </ul>
                            <p class="text-muted small">
                                Pour les listes imbriquées, utilisez le format : <code>liste1item1,liste1item2;liste2item1,liste2item2</code>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mise à jour du texte du bouton selon la case à cocher
    const validateOnlyCheckbox = document.getElementById('id_validate_only');
    const submitText = document.getElementById('submit-text');
    
    function updateSubmitText() {
        if (validateOnlyCheckbox.checked) {
            submitText.textContent = 'Valider uniquement';
        } else {
            submitText.textContent = 'Envoyer au Pipeline Spark';
        }
    }
    
    validateOnlyCheckbox.addEventListener('change', updateSubmitText);
    updateSubmitText(); // Appel initial
    
    // Validation du formulaire
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %} 